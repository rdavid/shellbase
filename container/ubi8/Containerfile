FROM registry.access.redhat.com/ubi8/ubi-minimal:8.5
LABEL maintainer="David Rabkin <david@rabkin.co.il>"
ENV \
	USER=shellbase

# redo needs diff (diffutils), which, and xargs (findutils).
RUN \
	microdnf update --assumeyes --disableplugin=subscription-manager && \
	rm --force --recursive /var/cache/yum && \
	microdnf install --assumeyes --disableplugin=subscription-manager \
		diffutils-3.6 \
		findutils-4.6.0 \
		git-2.27.0 \
		python36-3.6.8 \
		which-2.21 && \
	microdnf clean all --disableplugin=subscription-manager && \
	useradd --create-home "$USER"
RUN \
	git clone \
		--branch redo-0.42d \
		--config advice.detachedHead=false \
		--quiet \
		https://github.com/apenwarr/redo
WORKDIR /redo
RUN \
	DESTDIR='' PREFIX=/usr/local ./do --jobs=10 install >/dev/null 2>&1 && \
	./do --jobs=10 clean >/dev/null 2>&1
USER "$USER"
WORKDIR /home/"$USER"
COPY \
	--chown="$USER":"$USER" \
	. .
ENTRYPOINT \
	[ \
		"redo", \
		"--jobs=10", \
		"--verbose", \
		"--xtrace" \
	]
CMD \
	[ "test" ]
