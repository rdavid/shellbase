FROM ghcr.io/rdavid/goredoer:0.9.20230710 as goredoer
FROM archlinux:base
LABEL maintainer=David\ Rabkin\ <david@rabkin.co.il>
ENV \
	USER=shellbase
COPY LICENSE /licenses/LICENSE
WORKDIR /bin
COPY --from=goredoer /goredo .

# Multiple redirections compete for stdout.
# hadolint ignore=SC2261
RUN \
	pacman-key --init >/dev/null 2>&1 \
	&& pacman --noconfirm --refresh --sync archlinux-keyring >/dev/null 2>&1 \
	&& pacman --noconfirm --refresh --sync --sysupgrade >/dev/null 2>&1 \
	&& pacman --noconfirm --sync \
		bash>=5.1 \
		dash>=0.5 \
		fish>=3.6 \
		ksh>=2020 \
		shellcheck>=0.9.0 \
		shfmt>=3.6.0 \
		tcsh>=6.24 \
		yamllint>=1.31.0 \
		zsh>=r5.9 \
	&& useradd --create-home "$USER" \
	&& goredo -symlinks
USER "$USER"
WORKDIR /home/"$USER"
COPY \
	--chown="$USER":"$USER" \
	. .
CMD \
	[ "redo", "-j=10", "-x", "test" ]
