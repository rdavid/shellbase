FROM ghcr.io/rdavid/goredoer:0.9.20230808 as goredoer
FROM fedora:40
LABEL maintainer=David\ Rabkin\ <david@rabkin.co.il>
ENV \
	USER=shellbase
COPY LICENSE /licenses/LICENSE
WORKDIR /bin
COPY --from=goredoer /goredo .

# hadolint ignore=DL3041
RUN \
	dnf update --assumeyes \
		1>/dev/null 2>&1 \
	&& rm --force --recursive /var/cache/yum \
	&& dnf install --assumeyes \
		bash \
		findutils \
		hadolint \
		perl-Digest-SHA \
		shadow-utils \
		shellcheck \
		shfmt \
		procps \
		util-linux \
		yamllint \
		yash \
		1>/dev/null 2>&1 \
	&& dnf clean all \
	&& useradd --create-home "$USER" \
	&& goredo -symlinks
USER "$USER"
WORKDIR /home/"$USER"
COPY \
	--chown="$USER":"$USER" \
	. .
CMD \
	[ "redo", "-j=10", "-xx", "test" ]
